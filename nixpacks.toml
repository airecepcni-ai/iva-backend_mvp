# Nixpacks configuration for Railway deployment
# Ensures Playwright Chromium browser is installed at build time

[phases.setup]
# NOTE: These must be valid Nix package names (not Debian/apt package names).
# Keep this minimal: Nix chromium brings its runtime deps (incl. glib) and is usable via PATH.
# We still keep chromium available as a fallback option, but Playwright's bundled browser
# primarily needs system shared libs present in the container (installed via aptPkgs below).
nixPkgs = ["nodejs_20", "chromium", "glib"]

# Playwright Linux runtime dependencies (Ubuntu/Debian).
# This fixes errors like: "error while loading shared libraries: libglib-2.0.so.0"
# Ref: Playwright docs (chromium deps).
aptPkgs = [
  "libglib2.0-0",
  "libnss3",
  "libnspr4",
  "libatk1.0-0",
  "libatk-bridge2.0-0",
  "libcups2",
  "libdbus-1-3",
  "libdrm2",
  "libgbm1",
  "libxkbcommon0",
  "libxcomposite1",
  "libxdamage1",
  "libxfixes3",
  "libxrandr2",
  "libxshmfence1",
  "libpango-1.0-0",
  "libpangocairo-1.0-0",
  "libgtk-3-0",
  "libasound2",
  "libx11-xcb1"
]

[phases.install]
cmds = [
  "npm ci || npm install",
  "npx playwright install --with-deps chromium || npx playwright install chromium || echo 'Playwright install attempted'"
]

[phases.build]
cmds = ["npm run build || echo 'No build step'"]

[start]
cmd = "npm start"

[variables]
PLAYWRIGHT_BROWSERS_PATH = "0"
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD = "false"

